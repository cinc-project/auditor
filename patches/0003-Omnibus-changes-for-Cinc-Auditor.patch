From 4c89b1b555166e8433208b171f90beda9569661a Mon Sep 17 00:00:00 2001
From: Lance Albertson <lance@osuosl.org>
Date: Fri, 4 Oct 2019 21:44:21 -0700
Subject: [PATCH 3/4] Omnibus changes for Cinc Auditor

---
 omnibus/cinc-auditor/cinc-auditor-wrapper     | 21 +++++++++++++++++
 .../projects/{inspec.rb => cinc-auditor.rb}   | 23 ++++++++++---------
 omnibus/config/software/inspec.rb             |  3 +++
 .../{inspec => cinc-auditor}/postinst         | 17 ++++++++++----
 .../{inspec => cinc-auditor}/postrm           | 15 ++++++++++--
 .../{inspec => cinc-auditor}/preinst          |  2 +-
 .../{inspec => cinc-auditor}/prerm            |  0
 7 files changed, 63 insertions(+), 18 deletions(-)
 create mode 100755 omnibus/cinc-auditor/cinc-auditor-wrapper
 rename omnibus/config/projects/{inspec.rb => cinc-auditor.rb} (77%)
 rename omnibus/package-scripts/{inspec => cinc-auditor}/postinst (61%)
 rename omnibus/package-scripts/{inspec => cinc-auditor}/postrm (62%)
 rename omnibus/package-scripts/{inspec => cinc-auditor}/preinst (65%)
 rename omnibus/package-scripts/{inspec => cinc-auditor}/prerm (100%)

diff --git a/omnibus/cinc-auditor/cinc-auditor-wrapper b/omnibus/cinc-auditor/cinc-auditor-wrapper
new file mode 100755
index 00000000..413b83ac
--- /dev/null
+++ b/omnibus/cinc-auditor/cinc-auditor-wrapper
@@ -0,0 +1,21 @@
+#!/bin/sh
+#
+# Copyright:: Copyright 2019, Cinc Project
+# License:: Apache License, Version 2.0
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+echo "Redirecting to cinc-auditor..."
+
+exec /opt/cinc-auditor/bin/cinc-auditor $@
diff --git a/omnibus/config/projects/inspec.rb b/omnibus/config/projects/cinc-auditor.rb
similarity index 77%
rename from omnibus/config/projects/inspec.rb
rename to omnibus/config/projects/cinc-auditor.rb
index 827f61bc..23acf66d 100644
--- a/omnibus/config/projects/inspec.rb
+++ b/omnibus/config/projects/cinc-auditor.rb
@@ -1,5 +1,6 @@
 #
 # Copyright:: Copyright 2016-2018, Chef Software Inc.
+# Copyright:: Copyright 2019, Cinc Project
 # License:: Apache License, Version 2.0
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
@@ -17,18 +18,18 @@
 
 require_relative "../../../lib/inspec/version.rb"
 
-name "inspec"
-friendly_name "InSpec"
-maintainer "Chef Software, Inc <maintainers@chef.io>"
-homepage "https://github.com/inspec/inspec"
+name "cinc-auditor"
+friendly_name "Cinc Auditor"
+maintainer "Cinc Project <maintainers@cinc.sh>"
+homepage "https://gitlab.com/cinc-project/auditor"
 
-license "Chef EULA"
-license_file "CHEF-EULA.md"
+license "Apache-2.0"
+license_file "../LICENSE"
 
 # Defaults to C:/opscode/inspec on Windows
 # and /opt/inspec on all other platforms.
 if windows?
-  install_dir "#{default_root}/opscode/#{name}"
+  install_dir "#{default_root}/cinc-project/#{name}"
 else
   install_dir "#{default_root}/#{name}"
 end
@@ -54,7 +55,7 @@ dependency "openssl-customization"
 dependency "ruby-cleanup"
 
 package :rpm do
-  signing_passphrase ENV["OMNIBUS_RPM_SIGNING_PASSPHRASE"]
+  # signing_passphrase ENV["OMNIBUS_RPM_SIGNING_PASSPHRASE"]
   compression_level 1
   compression_type :xz
 end
@@ -65,8 +66,8 @@ package :deb do
 end
 
 package :pkg do
-  identifier "com.getchef.pkg.inspec"
-  signing_identity "Chef Software, Inc. (EU3VF8YLX2)"
+  identifier "com.cinc-project.pkg.cinc-auditor"
+  signing_identity nil
 end
 compress :dmg
 
@@ -74,7 +75,7 @@ package :msi do
   fast_msi true
   upgrade_code "DFCD452F-31E5-4236-ACD1-253F4720250B"
   wix_light_extension "WixUtilExtension"
-  signing_identity "AF21BA8C9E50AE20DA9907B6E2D4B0CC3306CA03", machine_store: true
+  # signing_identity "AF21BA8C9E50AE20DA9907B6E2D4B0CC3306CA03", machine_store: true
 end
 
 exclude "**/.git"
diff --git a/omnibus/config/software/inspec.rb b/omnibus/config/software/inspec.rb
index 7c0091c8..d3859843 100644
--- a/omnibus/config/software/inspec.rb
+++ b/omnibus/config/software/inspec.rb
@@ -1,5 +1,6 @@
 #
 # Copyright:: Copyright 2016-2019, Chef Software Inc.
+# Copyright:: Copyright 2019, Cinc Project
 # License:: Apache License, Version 2.0
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
@@ -58,4 +59,6 @@ build do
     gem_install_dir = shellout!("#{install_dir}/embedded/bin/gem open rubyzip", env: env).stdout.chomp
     remove_directory "#{gem_install_dir}/test"
   end
+
+  copy "#{project_dir}/cinc-auditor/cinc-auditor-wrapper", "#{install_dir}/bin/"
 end
diff --git a/omnibus/package-scripts/inspec/postinst b/omnibus/package-scripts/cinc-auditor/postinst
similarity index 61%
rename from omnibus/package-scripts/inspec/postinst
rename to omnibus/package-scripts/cinc-auditor/postinst
index a72e6085..dd46db02 100755
--- a/omnibus/package-scripts/inspec/postinst
+++ b/omnibus/package-scripts/cinc-auditor/postinst
@@ -5,8 +5,8 @@
 #
 
 PROGNAME=`basename $0`
-INSTALLER_DIR=/opt/inspec
-CONFIG_DIR=/etc/inspec
+INSTALLER_DIR=/opt/cinc-auditor
+CONFIG_DIR=/etc/cinc-auditor
 USAGE="usage: $0"
 
 error_exit()
@@ -27,7 +27,7 @@ else
     PREFIX="/usr"
 fi
 
-binaries="inspec"
+binaries="cinc-auditor"
 for binary in $binaries; do
   rm -f $PREFIX/bin/$binary
 done
@@ -36,11 +36,20 @@ for binary in $binaries; do
   ln -sf $INSTALLER_DIR/bin/$binary $PREFIX/bin || error_exit "Cannot link $binary to $PREFIX/bin"
 done
 
+wrapper_links="inspec"
+link_target="cinc-auditor-wrapper"
+for link in $wrapper_links; do
+  if [ ! -e $PREFIX/bin/$link ]; then
+    echo "Symlinking inspec command to cinc-auditor for compatibility..."
+    ln -sf $INSTALLER_DIR/bin/$link_target $PREFIX/bin/$link || error_exit "Cannot link $link_target to $PREFIX/bin/$link"
+  fi
+done
+
 # Ensure all files/directories in $INSTALLER_DIR are owned by root. This
 # has been fixed on new installs but upgrades from old installs need to
 # be manually fixed.
 chown -Rh 0:0 $INSTALLER_DIR
 
-echo "Thank you for installing InSpec!"
+echo "Thank you for installing Cinc Auditor!"
 
 exit 0
diff --git a/omnibus/package-scripts/inspec/postrm b/omnibus/package-scripts/cinc-auditor/postrm
similarity index 62%
rename from omnibus/package-scripts/inspec/postrm
rename to omnibus/package-scripts/cinc-auditor/postrm
index 94f9ddcf..58d79d0c 100755
--- a/omnibus/package-scripts/inspec/postrm
+++ b/omnibus/package-scripts/cinc-auditor/postrm
@@ -4,6 +4,8 @@
 # after package is uninstalled.
 #
 
+INSTALLER_DIR=/opt/cinc-auditor
+
 is_darwin()
 {
   uname -v | grep "^Darwin" 2>&1 >/dev/null
@@ -16,10 +18,19 @@ else
 fi
 
 cleanup_symlinks() {
-  binaries="inspec"
+  binaries="cinc-auditor"
   for binary in $binaries; do
     rm -f $PREFIX/bin/$binary
   done
+
+  wrapper_links="inspec"
+  link_target="cinc-auditor-wrapper"
+  for link in $wrapper_links; do
+    if [ -L $PREFIX/bin/$link -a "$(readlink $PREFIX/bin/$link)" = "$INSTALLER_DIR/bin/$link_target" ]; then
+      echo "Removing inspec compatibility symlink..."
+      rm -f $PREFIX/bin/$link
+    fi
+  done
 }
 
 # Clean up binary symlinks if they exist
@@ -32,6 +43,6 @@ elif [ "x$1" = "x0" ]; then
   cleanup_symlinks
 fi
 
-echo "InSpec has been uninstalled!"
+echo "Cinc Auditor has been uninstalled!"
 
 exit 0
diff --git a/omnibus/package-scripts/inspec/preinst b/omnibus/package-scripts/cinc-auditor/preinst
similarity index 65%
rename from omnibus/package-scripts/inspec/preinst
rename to omnibus/package-scripts/cinc-auditor/preinst
index 320429b9..f74efe65 100755
--- a/omnibus/package-scripts/inspec/preinst
+++ b/omnibus/package-scripts/cinc-auditor/preinst
@@ -4,4 +4,4 @@
 # before package is installed.
 #
 
-echo "You're about to install InSpec!"
+echo "You're about to install Cinc Auditor!"
diff --git a/omnibus/package-scripts/inspec/prerm b/omnibus/package-scripts/cinc-auditor/prerm
similarity index 100%
rename from omnibus/package-scripts/inspec/prerm
rename to omnibus/package-scripts/cinc-auditor/prerm
-- 
2.17.1

